
services:
  app:
    container_name: app
    build:
      context: ./app
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      # 👇 Ajusta el nombre de tu entrypoint Flask (app.py, main.py, etc.)
      - FLASK_APP=app/app.py
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
    volumes:
      # Hot-reload de tu código en desarrollo
      - ./:/app
    restart: unless-stopped
    healthcheck:
      # Requiere que tu app exponga /health (cámbialo o quítalo si no lo tienes)
      test: ["CMD", "sh", "-c", "curl -fsS http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # ---------- PRODUCCIÓN (opcional) ----------
    # Para producción, quita el volume y usa gunicorn:
    # command: gunicorn -w 2 -b 0.0.0.0:5000 app:app
    # environment:
    #   - FLASK_ENV=production
    #   - PYTHONUNBUFFERED=1
    # # Si usas gunicorn, asegúrate que tu módulo sea "app:app" (módulo:objeto WSGI)
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    ports:
      - "1883:1883"
  publisher:
    build: ./mqtt-publisher
    depends_on:
      - mosquitto

  subscriber:
    build: ./mqtt-client
    depends_on:
      - mosquitto
  mongodb:
    image: mongo:7
    container_name: mongodb
    ports:
      - "27017:27017"         # Exponlo solo en dev; en prod déjalo interno
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=rootpass
    volumes:
      - mongo_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped

volumes:
  mongo_data:
